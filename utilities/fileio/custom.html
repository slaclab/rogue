<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Writers &mdash; Rogue v5.11.0-2-g52767bd8 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Python File Reader" href="python_reader.html" />
    <link rel="prev" title="Reading Frames From A File" href="reading.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Rogue
          </a>
              <div class="version">
                v5.11.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installing/index.html">Installing &amp; Compiling Rogue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfaces/index.html">Interfaces</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Utilities</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">File I/O Utilities</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="writing.html">Writing Frames To A File</a></li>
<li class="toctree-l3"><a class="reference internal" href="reading.html">Reading Frames From A File</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Custom Writers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#custom-writer-subclass">Custom Writer Subclass</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="python_reader.html">Python File Reader</a></li>
<li class="toctree-l3"><a class="reference internal" href="classes/index.html">File Operation Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../prbs/index.html">PRBS Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/index.html">Compression Utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/index.html">Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocols/index.html">Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging/index.html">Logging In Rogue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_module/index.html">Creating Custom Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pydm/index.html">Using the PyDM Gui</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Rogue</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Utilities</a> &raquo;</li>
          <li><a href="index.html">File I/O Utilities</a> &raquo;</li>
      <li>Custom Writers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/utilities/fileio/custom.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-writers">
<span id="utilities-fileio-custom"></span><h1>Custom Writers<a class="headerlink" href="#custom-writers" title="Permalink to this headline"></a></h1>
<p>Rogue provides a standard class <a class="reference internal" href="classes/writer.html#utilities-fileio-writer"><span class="std std-ref">StreamWriter</span></a> for storing stream data
in Rogue. In some cases the user may want to implement a custom file format or may need to record
data in a pre-defined for certain DAQ systems. Rogue provides the ability to sub-class the StreamWriter
class, while keeping its core features including multiple segmented files and data buffering for burst
writing. To write a custom data format the user simply needs to sub-class the StreamWriter and override
the writeFile virtual method.</p>
<p>See <a class="reference internal" href="../../custom_module/index.html#custom-module"><span class="std std-ref">Creating Custom Modules</span></a> for more information about using this custom class in a Rogue library.</p>
<section id="custom-writer-subclass">
<h2>Custom Writer Subclass<a class="headerlink" href="#custom-writer-subclass" title="Permalink to this headline"></a></h2>
<p>The example below shows an example sub-class for writing Frame data to a text file.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rogue/utilities/fileio/StreamWriter.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rogue/interfaces/stream/Frame.h&gt;</span><span class="cp"></span>

<span class="n">class</span><span class="w"> </span><span class="nl">MyDataWriter</span> <span class="p">:</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">rogue</span><span class="o">::</span><span class="n">utilities</span><span class="o">::</span><span class="n">fileio</span><span class="o">::</span><span class="n">StreamWriter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">   </span><span class="nl">protected</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="n">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">writeFile</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rogue</span><span class="o">::</span><span class="n">interfaces</span><span class="o">::</span><span class="n">stream</span><span class="o">::</span><span class="n">Frame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Variables</span>
<span class="w">         </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Release the python GIL to avoid deadlocks</span>
<span class="w">         </span><span class="n">rogue</span><span class="o">::</span><span class="n">GilRelease</span><span class="w"> </span><span class="n">noGil</span><span class="p">;</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Lock the access to the local file</span>
<span class="w">         </span><span class="c1">// When the writeFile method is called, a lock is already held on the Frame instance</span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mtx_</span><span class="p">);</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Get the payload size from the frame</span>
<span class="w">         </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">getPayload</span><span class="p">();</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Call a helper function to check the file size and do housekeeping on the</span>
<span class="w">         </span><span class="c1">// memory resident buffer. This will close and open a new file if we have</span>
<span class="w">         </span><span class="c1">// reached the max size and will flush the memory buffer to a file if we</span>
<span class="w">         </span><span class="c1">// have reached the requested burst size.</span>
<span class="w">         </span><span class="n">checkSize</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Get an iterator to the frame data</span>
<span class="w">         </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>

<span class="w">         </span><span class="c1">// First line is the size in 32-bit values</span>
<span class="w">         </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Call the underlying write functions</span>
<span class="w">         </span><span class="n">intWrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Loop through the rest of the file</span>
<span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">fromFrame</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span><span class="o">:</span><span class="w"></span>
<span class="w">            </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">intWrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="w">         </span><span class="c1">// Update the frame count</span>
<span class="w">         </span><span class="n">frameCount_</span><span class="w"> </span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">         </span><span class="c1">// This helps update the class state</span>
<span class="w">         </span><span class="n">cond_</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Smart pointer alias for our custom class</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MyDataWriter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyDataWriterPtr</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Once your custom writer is created you may want to use it in the Rogue tree, allowing you to open and write
files using the Rogue PyDM GUI. You can sub-class the rogue StreamWriter class for use with your custom
module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyrogue</span>
<span class="kn">import</span> <span class="nn">pyrogue.utilities.fileio</span>

<span class="c1"># Assume we have to incoming data streams, streamA and streamB coming from a pair</span>
<span class="c1"># of stream Masters</span>
<span class="c1"># streamA</span>
<span class="c1"># streamB</span>

<span class="c1"># Instantiate your custom writer</span>
<span class="n">mywrite</span> <span class="o">=</span> <span class="n">MyWriter</span><span class="p">()</span>

<span class="c1"># Pass the custom writer to the Rogue wrapper</span>
<span class="n">fwrite</span> <span class="o">=</span> <span class="n">pyrogue</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">fileio</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">(</span><span class="n">writer</span><span class="o">=</span><span class="n">myWrite</span><span class="p">)</span>

<span class="c1"># Add the file writer to the Rogue tree.</span>
<span class="n">root</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fwrite</span><span class="p">)</span>

<span class="c1"># Don&#39;t set any other parameters as you will use the Rogue tree to set the</span>
<span class="c1"># file parameters and open/close files</span>

<span class="c1"># Connect stream A to the file writer channel 0</span>
<span class="n">streamA</span> <span class="o">&gt;&gt;</span> <span class="n">fwrite</span><span class="o">.</span><span class="n">getChannel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Connect stream B to the file writer channel 1</span>
<span class="n">streamB</span> <span class="o">&gt;&gt;</span> <span class="n">fwrite</span><span class="o">.</span><span class="n">getChannel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="reading.html" class="btn btn-neutral float-left" title="Reading Frames From A File" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="python_reader.html" class="btn btn-neutral float-right" title="Python File Reader" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>